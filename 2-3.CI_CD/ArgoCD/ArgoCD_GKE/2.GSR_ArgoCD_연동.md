# ArgoCDì™€ Google Source Repository ì—°ë™ 
- Helmìœ¼ë¡œ ë°°í¬í•œ ArgoCDì— Google Source Repositoryë¥¼ ì—°ë™
- Google Source Repositoryì— yamlíŒŒì¼ì„ ì—…ë°ì´íŠ¸ í•˜ë©´ ìë™ìœ¼ë¡œ ë³€ë™ì‚¬í•­ì„ ê°ì§€í•˜ì—¬ GKEì— ë°˜ì˜í•˜ëŠ” êµ¬ì¡°


## GCP Service Account ì„¤ì • 
- ì—°ê²°í•  Service Accountì˜ í‚¤ íŒŒì¼ì„ Json í˜•íƒœë¡œ ë‹¤ìš´ë¡œë“œ 

- GCP ì½˜ì†”
    - IAM ë° ê´€ë¦¬ì > ì„œë¹„ìŠ¤ ê³„ì • > í‚¤ 
        - í‚¤ ì¶”ê°€ > JSON ìœ í˜•ìœ¼ë¡œ ë§Œë“¤ê¸° 
        - ìƒì„±ì‹œ ìë™ìœ¼ë¡œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ 

## Google Source Repository ì„¤ì • 

- ì—°ê²°í•  Google Source Repository ì €ì¥ì†Œë¥¼ ìƒì„± 
    - ì €ì¥ì†Œ ëª… : argocd-gsr-repo
    - ì„¤ì • > ê¶Œí•œ 
        - í‚¤ë¥¼ ë‹¤ìš´ë¡œë“œí•œ ì„œë¹„ìŠ¤ ê³„ì •ì— ê¶Œí•œì„ ì¶”ê°€ 
        - ìµœì†Œ `Source Repository Reader` í•„ìš” 

- ì„œë²„ í˜¹ì€ vscodeì—ì„œ Google Source Repositoryì— ì—°ê²° 
    - ì¸ì¦ë°©ì‹ì€ `ìˆ˜ë™ìœ¼ë¡œ ìƒì„±ëœ ì‚¬ìš©ì ì¸ì¦ì •ë³´` ì‚¬ìš©
    - `Git ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ìƒì„± ë° ì €ì¥` í´ë¦­í•˜ì—¬ google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
        - ì•„ë˜ ë¶€ë¶„ì˜ ì¸ì¦ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ì‚¬ìš©ì ì¸ì¦ì •ë³´ ìƒì„±

    - ArgoCDì—ì„œ ë°°í¬ë¥¼ ìœ„í•´ í…ŒìŠ¤íŠ¸ìš© YamlíŒŒì¼ ìƒì„±
    
    > test_nginx.yaml
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: nginx-deployment
      labels:
        app: nginx
    spec:
      replicas: 1  # ì›í•˜ëŠ” Pod ê°œìˆ˜ ì„¤ì •
      strategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 0
      selector:
        matchLabels:
          app: nginx
      template:
        metadata:
          labels:
            app: nginx
        spec:
          terminationGracePeriodSeconds: 120
          containers:
            - name: nginx
              image: nginx:latest
              ports:
                - containerPort: 80
              lifecycle:
                preStop:
                  exec:
                    command: ["bin/sh", "-c", "sleep 60"]
    ```

    - ë””ë ‰í† ë¦¬ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í•˜ì—¬ Commit & Push
    ```
    ğŸ“¦argo-gsr-repo
     â”£ ğŸ“‚test_nginx
     â”ƒ â”— ğŸ“œtest_nginx.yaml
     ```




## ArgoCD - Repositories ì¶”ê°€ 
- ArgoCD ì›¹ UIì— ë¡œê·¸ì¸ í›„ Settings > Repositories > CONNECT REPO ë¡œ GSR ì—°ê²° ì¶”ê°€

- ì—°ê²° êµ¬ì„± 
    - Choose your connection method : VIA GOOGLE CLOUD
    - Project : default
    - Repository URL : https://source.developers.google.com/p/test-project/r/argocd-gsr-repo (í´ë¡  > `ìˆ˜ë™ìœ¼ë¡œ ìƒì„±ëœ ì‚¬ìš©ì ì¸ì¦ì •ë³´` ì—ì„œ í™•ì¸ ê°€ëŠ¥)
    - GCP service account key : ì„œë¹„ìŠ¤ í‚¤ Json íŒŒì¼ì˜ ë‚´ìš©ì„ ë¶™ì—¬ë„£ê¸°
    
    - ìƒë‹¨ì˜ Connectë¡œ ì—°ê²° ìƒì„± 

- Connection Statusê°€ `Failed` ì¸ ê²½ìš° í™•ì¸ ì‚¬í•­ 
    - í‚¤ë¥¼ ë“±ë¡í•œ ì„œë¹„ìŠ¤ê³„ì •ì— í•´ë‹¹ ì €ì¥ì†Œì˜ ê¶Œí•œì´ `Source Repository Reader` ì´ìƒìœ¼ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
    - ë¨¼ì € ê¶Œí•œ ë¶€ì—¬ í›„ì— ì—°ê²°ì„ ì¶”ê°€í•´ì•¼ ì •ìƒì ìœ¼ë¡œ ì—°ê²°ë¨
    
## ArgoCD - Application ì¶”ê°€ 

- ì—°ê²°ì˜ ì˜¤ë¥¸ìª½ `â‹®` ë²„íŠ¼ì—ì„œ `Create application` í˜¹ì€ Application íƒ­ì˜ `+ New APP` ìœ¼ë¡œ ì‹ ê·œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ì¶”ê°€ 

- Application ì •ë³´
    - General
        - Application Name : test-nginx
        - Project : default
        - Sync Policy : Manual 
            - Manual : ì†ŒìŠ¤ì˜ ë³€ë™ì‚¬í•­ì´ ê°ì§€ë˜ì–´ë„ ìë™ìœ¼ë¡œ ë™ê¸°í™” X
            - Automatic : ì†ŒìŠ¤ì˜ ë³€ë™ì‚¬í•­ì´ ê°ì§€ë˜ë©´ ìë™ìœ¼ë¡œ ë™ê¸°í™” 
    - Source
        - Repository URL : https://source.developers.google.com/p/test-project/r/argocd-gsr-repo
        - Revision : HEAD
        - Path : test_nginx 
            - yaml íŒŒì¼ì´ í¬í•¨ë˜ëŠ” ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ì§€ì •
    - DESTINATION
        - Cluster URL : https://kubernetes.default.svc
        - Namespace : default 
            - defaultë¡œ ì§€ì •í•˜ë”ë¼ë„ ìƒëµ ë¶ˆê°€
            - ë™ê¸°í™” ì˜µì…˜ì—ì„œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìë™ ìƒì„± ì˜µì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë¯¸ë¦¬ ìƒì„± í•„ìš”

- ì°¸ê³  - ArgoCD ì €ì¥ì†Œì˜ ë””ë ‰í† ë¦¬ êµ¬ì„± 
    - ArgoCDëŠ” Pathì— ì§€ì •ëœ ê°’ì— ë”°ë¼ Kubernetes manifestsë¥¼ ì°¾ì„ ê²½ë¡œë¥¼ íƒìƒ‰
    - ì–´í”Œë¦¬ì¼€ì´ì…˜ ë³„ ë””ë ‰í† ë¦¬ë¡œ êµ¬ë¶„í•˜ì—¬ êµ¬ì„±í•˜ê³ , ì´ë¥¼ í†µí•´ Application ì¶”ê°€í•˜ëŠ” í˜•íƒœ
    - íŒŒì¼ ì´ë¦„ì€ ììœ ë¡­ê²Œ ì§€ì •í•  ìˆ˜ ìˆìœ¼ë‚˜, íŒŒì¼ë“¤ì€ ëª¨ë‘ ì˜¬ë°”ë¥¸ Kubernetes ë¦¬ì†ŒìŠ¤ ì •ì˜ë¥¼ í¬í•¨í•˜ê³  ìˆì–´ì•¼ í•¨
    
    ```
    # ë‹¤ìŒê³¼ ê°™ì€ Git Repository êµ¬ì„±ì—ì„œ appì„ pathë¡œ ì§€ì •í•˜ë©´ ë‚´ë¶€ ë¦¬ì†ŒìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ìˆ˜ ìˆìŒ
    my-repo/
    â”œâ”€â”€ app/
    â”‚   â”œâ”€â”€ deployment.yaml
    â”‚   â”œâ”€â”€ service.yaml
    â”‚   â””â”€â”€ ingress.yaml
    ```

## ArgoCD - Applciation Sync í…ŒìŠ¤íŠ¸ 

### Manual Sync Policy
- test_nginx.yamlì˜ replicasë¥¼ 1 > 2ë¡œ ë³€ê²½í•˜ì—¬ Push
    - Statusì— `OutofSync` í‘œê¸°ë¨
    - `DIFF`ë¥¼ í†µí•´ ì–´ë–¤ ë³€ê²½ì ì´ ìˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥
    - ìˆ˜ë™ìœ¼ë¡œ SYNCë¥¼ í†µí•´ ë™ê¸°í™” ì§„í–‰ 
    - Sync ì™„ë£Œë˜ë©´ ì›¹ UI ìƒì—ì„œ pod 2ê°œë¡œ ëŠ˜ì–´ë‚œê²ƒì„ í™•ì¸ ê°€ëŠ¥ 
    - í´ëŸ¬ìŠ¤í„° ìƒì—ì„œë„ ì •ìƒì ìœ¼ë¡œ ë™ê¸°í™” í™•ì¸
    
    ```
    NAME                                    READY   STATUS    RESTARTS   AGE
    pod/nginx-deployment-58c75ff575-lhg88   1/1     Running   0          7m40s
    pod/nginx-deployment-58c75ff575-mfdnp   1/1     Running   0          98s

    NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
    deployment.apps/nginx-deployment   2/2     2            2           7m40s

    NAME                                          DESIRED   CURRENT   READY   AGE
    replicaset.apps/nginx-deployment-58c75ff575   2         2         2       7m40s
    ```

### Automatic Sync Policy 
- ë³€ê²½í•  Application ì„ íƒ > DETAILS > edit > SYNC POLICY > AUTOMATED > ENABLE AUTO-SYNC ë¡œ í™œì„±í™” 

- AUTOMATED ëª¨ë“œì˜ ì¶”ê°€ ì˜µì…˜
    - `PRUNE RESOURCE` : Git ì €ì¥ì†Œì—ì„œ ì‚­ì œëœ ë¦¬ì†ŒìŠ¤ë¥¼ í´ëŸ¬ìŠ¤í„°ì—ì„œë„ ìë™ìœ¼ë¡œ ì œê±°
        - ex)  Gitì— service.yaml íŒŒì¼ì´ ìˆì—ˆëŠ”ë° ì´ë¥¼ ì‚­ì œí•˜ë©´, ArgoCDê°€ í´ëŸ¬ìŠ¤í„°ì—ì„œë„ í•´ë‹¹ ì„œë¹„ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ìë™ ì‚­ì œ
    - `SELF HEAL` : í´ëŸ¬ìŠ¤í„° ë‚´ ë¦¬ì†ŒìŠ¤ê°€ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½ë˜ê±°ë‚˜ ì†ìƒë˜ì—ˆì„ ë•Œ, Gitì˜ ì˜¬ë°”ë¥¸ ìƒíƒœë¡œ ìë™ ë³µì›
        - ex) Gitì—ì„œëŠ” replicas: 3ìœ¼ë¡œ ì •ì˜í–ˆì§€ë§Œ, í´ëŸ¬ìŠ¤í„°ì—ì„œ replicas: 1ë¡œ ìˆ˜ì •í•œ ê²½ìš°, ArgoCDê°€ ìë™ìœ¼ë¡œ ë‹¤ì‹œ 3ìœ¼ë¡œ ë³µì›

- test_nginx.yamlì˜ replicasë¥¼ 2 > 1ë¡œ ì›ë³µ í›„ Push

    - ìë™ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•˜ì—¬ ë™ê¸°í™” ì§„í–‰ 
    ```
    $ kubectl get all
    NAME                                    READY   STATUS        RESTARTS   AGE
    pod/nginx-deployment-58c75ff575-lhg88   1/1     Running       0          17m
    pod/nginx-deployment-58c75ff575-mfdnp   1/1     Terminating   0          11m
    NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
    service/kubernetes   ClusterIP   34.118.224.1   <none>        443/TCP   5h34m
    NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
    deployment.apps/nginx-deployment   1/1     1            1           17m
    NAME                                          DESIRED   CURRENT   READY   AGE
    replicaset.apps/nginx-deployment-58c75ff575   1         1         1       17m
    ```

### SELF HEAL í…ŒìŠ¤íŠ¸
- SELF HEAL ì˜µì…˜ì„ í™œì„±í™” í›„, Kubectl editì„ í†µí•´ replicasë¥¼ 2ë¡œ ë³€ê²½ 
     - ArgoCD ìƒì—ì„œ OutOfSyncë¥¼ ê°ì§€í•˜ì—¬ ë‹¤ì‹œ replicasë¥¼ 1ë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì„ í™•ì¸

### PRUNE RESOURCE í…ŒìŠ¤íŠ¸ 
- PRUNE RESOURCE ì˜µì…˜ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì¶”ê°€ pod ë° ì„œë¹„ìŠ¤ yamlíŒŒì¼ ì¶”ê°€ í•˜ì—¬ Push

> test_pod.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
  - name: test-container
    image: nginx:latest
    ports:
    - containerPort: 80
```
> test_pod_svc.yaml
```yaml
apiVersion: v1
kind: Service
metadata:
  name: test-service
spec:
  selector:
    app: test-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP
```
    
- PRUNE RESOURCE ì˜µì…˜ ë¹„í™œì„±í™” ìƒíƒœì—ì„œ test_pod_svc.yaml ì‚­ì œ í›„ Push
    - ArgoCD UI ìƒì—ì„œëŠ” test-serviceê°€ OutOfSync ìƒíƒœë¡œ ë‚¨ì•„ìˆìŒ 

- PRUNE RESOURCE ì˜µì…˜ í™œì„±í™” ìƒíƒœì—ì„œ test_pod_svc.yaml ì‚­ì œ í›„ Push    
    - ArgoCD UI ìƒì— test-serviceë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œ
    
- ë””ë ‰í† ë¦¬ ìì²´ë¥¼ ì‚­ì œí›„ì— Push í•´ë„ ArgoCDì— ì •ì˜ëœ Applicationì´ ì‚­ì œë˜ì§€ëŠ” ì•ŠìŒ 
    - ìˆ˜ë™ ì‚­ì œ í•„ìš”    