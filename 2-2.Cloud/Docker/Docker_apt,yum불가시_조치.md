# Docker Build 혹은 Container 상에서 패키지 관리자 사용 불가 시 조치 사항 

##  BuildKit 비활성화 
- Buildkit을 사용하는 버전의 Docker는 빌드시 기본적으로 격리된 네트워크 환경에서 실행 
- 이로 인해 apt,yum 등의 패키지를 설치하지 못하는 현상 발생 가능 

```
DOCKER_BUILDKIT=0 docker build -t my-image .
```

## network=host로 지정 
- 기본 Bridge 네트워크가 아닌 host 네트워크를 사용하여 연결이 가능하도록 설정 
```
$ docker network ls 
host
bridge
none 

$ docker run --network=host -d -p 8080:80 --name nginx nginx:latest
```

## DNS 정보 확인 
- GCP,AWS 등 Public Cloud 상의 VM은 DNS 정보가 다르게 설정되어있음 
- Docker가 해당 DNS 정보를 가져오지 못하면 기본 DNS 설정값인 8.8.8.8, 8.8.4.4를 추가하여 사용 
- docker에서 특정 DNS 정보를 고정으로 사용하도록 변경 필요 


### VM DNS 정보 확인 (GCP VM)

- CentOS/RHEL
```bash
$ cat /etc/resolv.conf
# Generated by NetworkManager
search asia-northeast3-c.c.test-project.internal c.test-project.internal google.internal
nameserver 169.254.169.254  # GCP 기본 DNS 
```
- Ubuntu
```bash
$ cat /etc/resolv.conf
# Generated by NetworkManager
search asia-northeast3-c.c.test-project.internal c.test-project.internal google.internal
nameserver 127.0.0.53
```
- systemd-resolved 서비스로 인해 127.0.0.53으로 설정 
    - 127.0.0.53 : 로컬 캐싱 DNS 리졸버 역할을 하는 systemd-resolved의 내부 주소
        - 모든 DNS 요청은 127.0.0.53로 보내지고 systemd-resolved가 실제 DNS 서버로 요청을 전달하는 구조 
    
    - 실제 DNS 서버 확인 방법
    ```bash
    $ systemd-resolve --status | grep 'DNS Servers' -A2
    
    or

    $ resolvectl status

    # 실제 DNS 
    DNS Servers: 169.254.169.254
    ```    


### Docker Container DNS 정보 확인 (GCP VM)
- 정상적으로 DNS 정보를 가져오는 경우 
    - `nameserver 169.254.169.254`로 설정됨
```bash
$ docker run --rm ubuntu:latest cat /etc/resolv.conf
Unable to find image 'ubuntu:latest' locally
latest: Pulling from library/ubuntu
5a7813e071bf: Pull complete
Digest: sha256:72297848456d5d37d1262630108ab308d3e9ec7ed1c3286a32fe09856619a782
Status: Downloaded newer image for ubuntu:latest
# Generated by NetworkManager
search asia-northeast3-c.c.test-project.internal c.test-project.internal google.internal
nameserver 169.254.169.254
```
- 제대로 가져오지 못하는 경우 
    - 8.8.8.8, 8.8.4.4 로 설정됨됨
```bash
$ docker run --rm ubuntu:latest cat /etc/resolv.conf
Unable to find image 'ubuntu:latest' locally
latest: Pulling from library/ubuntu
5a7813e071bf: Pull complete
Digest: sha256:72297848456d5d37d1262630108ab308d3e9ec7ed1c3286a32fe09856619a782
Status: Downloaded newer image for ubuntu:latest
# Generated by NetworkManager
search asia-northeast3-c.c.test-project.internal c.test-project.internal google.internal
nameserver 8.8.8.8
nameserver 8.8.4.4
```

### Docker Daemon의 DNS 설정 변경 (GCP VM)

- Docker의 기본 DNS를 GCP DNS로 설정 
```bash
tee /etc/docker/daemon.json <<EOF
{
  "dns": ["169.254.169.254"]
}
EOF
```

- Docker 재시작 
```bash
systemctl restart docker
```

- Container에서 DNS 정보 재확인 
```bash
$ docker run --rm ubuntu:latest cat /etc/resolv.conf
Unable to find image 'ubuntu:latest' locally
latest: Pulling from library/ubuntu
5a7813e071bf: Pull complete
Digest: sha256:72297848456d5d37d1262630108ab308d3e9ec7ed1c3286a32fe09856619a782
Status: Downloaded newer image for ubuntu:latest
# Generated by NetworkManager
search asia-northeast3-c.c.test-project.internal c.test-project.internal google.internal
nameserver 169.254.169.254
```


