<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>모델 비교 - Sentiment Analysis</title>

    <link href="static/css/bootstrap.min.css" rel="stylesheet" />
    <link href="static/css/sb-admin-2.min.css" rel="stylesheet" />
    <link href="static/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
    <link href="static/css/jquery-ui.min.css" rel="stylesheet" />

    <style>
      thead input, thead select {
        width: 100%;
        box-sizing: border-box;
        height: 32px;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      th.date-filter {
        min-width: 250px;
        white-space: nowrap;
      }
      .date-range-group {
        display: flex;
        gap: 6px;
      }
      .date-range-group input {
        width: 120px;
        min-width: 100px;
        max-width: 130px;
        display: inline-block;
        margin: 0;
      }
      /* DataTables 툴바 custom 버튼 위치 조정 */
      .dt-toolbar {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      /* 필터 토글 버튼 스타일 조정 */
      #toggle-filter-btn {
        padding: 3px 8px;
        font-size: 0.875rem;
      }
    </style>
</head>
<body id="page-top">

{% include 'header.html' %}

<div class="container-fluid mt-4">

    <div class="table-responsive">
        <table class="table table-bordered" id="comparisonTable" width="100%" cellspacing="0">

            <thead class="thead-dark">
                <!-- 컬럼 제목 행 -->
                <tr>
                    <th>id</th>
                    <th>keyword_id</th>
                    <th>keyword</th>
                    <th>title</th>
                    <th>content</th>
                    <th>url</th>
                    {% for model in model_list %}
                        <th>{{ model }} 감정</th>
                        <th>{{ model }} 점수</th>
                    {% endfor %}
                    <th>published_at</th>
                    <th>collected_at</th>
                </tr>

                <!-- 필터 입력 행 (기본 숨김) -->
                <tr id="filter-row" style="display:none;">
                    <th><input type="text" placeholder="검색 id" /></th>
                    <th><input type="text" placeholder="검색 keyword_id" /></th>
                    <th>
                        <select>
                            <option value="">전체</option>
                            {% for kw in keyword_set %}
                                <option value="{{ kw }}">{{ kw }}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th><input type="text" placeholder="검색 title" /></th>
                    <th><input type="text" placeholder="검색 content" /></th>
                    <th><input type="text" placeholder="검색 url" /></th>

                    {% for model in model_list %}
                        <th>
                            <select>
                                <option value="">전체</option>
                                {% for sent in sentiment_map.get(model, []) %}
                                    <option value="{{ sent }}">{{ sent.capitalize() }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th><input type="text" placeholder="검색 점수" /></th>
                    {% endfor %}

                    <th class="date-filter">
                        <div class="date-range-group">
                            <input type="text" id="published_at_min" placeholder="시작일 (YYYY-MM-DD)" autocomplete="off" />
                            <input type="text" id="published_at_max" placeholder="종료일 (YYYY-MM-DD)" autocomplete="off" />
                        </div>
                    </th>
                    <th class="date-filter">
                        <div class="date-range-group">
                            <input type="text" id="collected_at_min" placeholder="시작일 (YYYY-MM-DD)" autocomplete="off" />
                            <input type="text" id="collected_at_max" placeholder="종료일 (YYYY-MM-DD)" autocomplete="off" />
                        </div>
                    </th>
                </tr>
            </thead>

            <tbody>
                {% for article in combined_data.values() %}
                <tr>
                    <td>{{ article.meta[0] }}</td>
                    <td>{{ article.meta[1] }}</td>
                    <td>{{ article.meta[2] }}</td>
                    <td>{{ article.meta[3] }}</td>
                    <td>{{ article.meta[4] }}</td>
                    <td><a href="{{ article.meta[5] }}" target="_blank" rel="noopener noreferrer">기사링크</a></td>
                    {% for model in model_list %}
                        {% set result = article.models.get(model) %}
                        {% if result %}
                            {% set sent_lower = result.sentiment|lower %}
                            {% set score = result.score %}
                            <td>{{ emoji_map.get(model, {}).get(sent_lower, '❓') }} {{ result.sentiment }}</td>
                            <td style="min-width: 120px;">
                                <div>{{ "%.3f"|format(score) }}</div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar"
                                         style="width: {{ (score * 100)|round(2) }}%;"
                                         aria-valuenow="{{ (score * 100)|round(2) }}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                        {% else %}
                            <td>-</td>
                            <td>-</td>
                        {% endif %}
                    {% endfor %}
                    <td>{{ article.meta[6] }}</td>
                    <td>{{ article.meta[7] }}</td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>
</div>

<!-- JS 로드 -->
<script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/dataTables.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>

<script>
$(document).ready(function() {
    var table = $('#comparisonTable').DataTable({
        // 기본 dom 구조 유지 (검색창은 오른쪽 상단, lengthMenu는 왼쪽 상단)
        orderCellsTop: true,
        fixedHeader: true,
        language: {
            search: "검색:",
            lengthMenu: "페이지당 _MENU_ 개씩 보기",
            info: "_TOTAL_건 중 _START_~_END_번째",
            paginate: { next: "다음", previous: "이전" }
        }
    });

    // 기존에 존재하는 필터 토글 버튼 제거 후, 페이지당 보기 옆에 버튼 삽입
    $('#toggle-filter-btn').remove();
    $('<button id="toggle-filter-btn" class="btn btn-secondary ml-2 btn-sm">필터 토글</button>')
        .insertAfter('.dataTables_length');

    // 필터 토글 버튼 클릭 시 필터 행 보이기/숨기기
    $(document).on('click', '#toggle-filter-btn', function() {
        $('#filter-row').toggle();
        table.columns.adjust().draw();
    });

    // 텍스트 필터링 (날짜 필터 제외)
    $('#comparisonTable thead tr:eq(1) th').each(function(i) {
        var input = $(this).find('input[type="text"]:not(#published_at_min):not(#published_at_max):not(#collected_at_min):not(#collected_at_max)');
        if (input.length) {
            input.on('keyup change clear', function() {
                if (table.column(i).search() !== this.value) {
                    table.column(i).search(this.value).draw();
                }
            });
        }
    });

    // 드롭다운 필터 (대소문자 구분 없이 단순 포함 검색)
    $('#comparisonTable thead tr:eq(1) th').each(function(i) {
        var select = $(this).find('select');
        if (select.length) {
            select.on('change', function() {
                var val = $(this).val();
                table.column(i).search(val || '', false, false).draw();
            });
        }
    });

    // Datepicker 초기화
    $("#published_at_min, #published_at_max, #collected_at_min, #collected_at_max").datepicker({
        dateFormat: "yy-mm-dd"
    });

    // 날짜 범위 필터 함수 (시간 제거 후 비교)
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        var model_count = {{ model_list|length }};
        var publishedAtIndex = 6 + (model_count * 2);
        var collectedAtIndex = publishedAtIndex + 1;

        // 시간 제외하고 날짜만 추출
        function extractDatePart(datetimeStr) {
            if (!datetimeStr) return null;
            var datePart = datetimeStr.split(' ')[0]; // 'YYYY-MM-DD hh:mm:ss' -> 'YYYY-MM-DD'
            return datePart;
        }
        function parseDate(s) {
            if (!s) return null;
            var parts = s.split('-');
            if(parts.length !== 3) return null;
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }

        var publishedRaw = data[publishedAtIndex];
        var collectedRaw = data[collectedAtIndex];

        var published = parseDate(extractDatePart(publishedRaw));
        var collected = parseDate(extractDatePart(collectedRaw));

        var publishedMin = $('#published_at_min').val();
        var publishedMax = $('#published_at_max').val();
        var collectedMin = $('#collected_at_min').val();
        var collectedMax = $('#collected_at_max').val();

        var publishedMinDate = parseDate(publishedMin);
        var publishedMaxDate = parseDate(publishedMax);
        var collectedMinDate = parseDate(collectedMin);
        var collectedMaxDate = parseDate(collectedMax);

        if (published) {
            if (publishedMinDate && published < publishedMinDate) return false;
            if (publishedMaxDate && published > publishedMaxDate) return false;
        }
        if (collected) {
            if (collectedMinDate && collected < collectedMinDate) return false;
            if (collectedMaxDate && collected > collectedMaxDate) return false;
        }
        return true;
    });

    // 날짜 필터 input 변경 시 테이블 재검색
    $('#published_at_min, #published_at_max, #collected_at_min, #collected_at_max').on('change', function() {
        table.draw();
    });
});
</script>

</body>
</html>

