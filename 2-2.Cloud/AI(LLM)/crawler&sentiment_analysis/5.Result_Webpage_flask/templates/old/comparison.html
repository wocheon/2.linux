<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>모델 비교 - Sentiment Analysis</title>

    <link href="static/css/bootstrap.min.css" rel="stylesheet" />
    <link href="static/css/sb-admin-2.min.css" rel="stylesheet" />
    <link href="static/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
    <style>
      thead input, thead select {
        width: 100%;
        box-sizing: border-box;
        height: 32px;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
</head>
<body id="page-top">

{% include 'header.html' %}

<div class="container-fluid mt-4">

    <!-- 필터 토글 버튼 -->
    <button id="toggle-filter-btn" class="btn btn-secondary mb-3">필터 토글</button>

    <div class="table-responsive">
        <table class="table table-bordered" id="comparisonTable" width="100%" cellspacing="0">

            <thead class="thead-dark">
                <!-- 컬럼 타이틀 행 -->
                <tr>
                    <th>id</th>
                    <th>keyword_id</th>
                    <th>keyword</th>
                    <th>title</th>
                    <th>content</th>
                    <th>url</th>

                    {% for model in model_list %}
                        <th>{{ model }} 감정</th>
                        <th>{{ model }} 점수</th>
                    {% endfor %}

                    <th>published_at</th>
                    <th>collected_at</th>
                </tr>

                <!-- 필터 입력행: 기본 숨김, 토글 버튼으로 보임/숨김 -->
                <tr id="filter-row" style="display:none;">
                    <th><input type="text" placeholder="검색 id" /></th>
                    <th><input type="text" placeholder="검색 keyword_id" /></th>

                    <!-- keyword 드롭다운 필터 -->
                    <th>
                      <select>
                        <option value="">전체</option>
                        {% for kw in keyword_set %}
                            <option value="{{ kw }}">{{ kw }}</option>
                        {% endfor %}
                      </select>
                    </th>

                    <th><input type="text" placeholder="검색 title" /></th>
                    <th><input type="text" placeholder="검색 content" /></th>
                    <th><input type="text" placeholder="검색 url" /></th>

                    {% for model in model_list %}
                      <!-- 모델별 감정 드롭다운 필터 -->
                      <th>
                        <select>
                          <option value="">전체</option>
                          {% for sent in sentiment_map.get(model, []) %}
                              <option value="{{ sent }}">{{ sent.capitalize() }}</option>
                          {% endfor %}
                        </select>
                      </th>
                      <!-- 점수는 텍스트 필터 유지 -->
                      <th><input type="text" placeholder="검색 점수" /></th>
                    {% endfor %}

                    <th><input type="text" placeholder="검색 published_at" /></th>
                    <th><input type="text" placeholder="검색 collected_at" /></th>
                </tr>
            </thead>

            <tbody>
                {% for article in combined_data.values() %}
                <tr>
                    <td>{{ article.meta[0] }}</td>  <!-- id -->
                    <td>{{ article.meta[1] }}</td>  <!-- keyword_id -->
                    <td>{{ article.meta[2] }}</td>  <!-- keyword -->
                    <td>{{ article.meta[3] }}</td>  <!-- title -->
                    <td>{{ article.meta[4] }}</td>  <!-- content -->
                    <td><a href="{{ article.meta[5] }}" target="_blank" rel="noopener noreferrer">기사링크</a></td>

                    {% for model in model_list %}
                        {% set result = article.models.get(model) %}
                        {% if result %}
                            {% set sent_lower = result.sentiment|lower %}
                            {% set score = result.score %}
                            <td>{{ emoji_map.get(model, {}).get(sent_lower, '❓') }} {{ result.sentiment }}</td>
                            <td style="min-width: 120px;">
                                <div>{{ "%.3f"|format(score) }}</div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar"
                                         style="width: {{ (score * 100)|round(2) }}%;"
                                         aria-valuenow="{{ (score * 100)|round(2) }}"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </td>
                        {% else %}
                            <td>-</td>
                            <td>-</td>
                        {% endif %}
                    {% endfor %}

                    <td>{{ article.meta[6] }}</td>  <!-- published_at -->
                    <td>{{ article.meta[7] }}</td>  <!-- collected_at -->
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>
</div>

<!-- JS 로드 -->
<script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/dataTables.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>

<script>
$(document).ready(function() {
    var table = $('#comparisonTable').DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        "language": {
          "search": "검색:",
          "lengthMenu": "페이지당 _MENU_ 개씩 보기",
          "info": "_TOTAL_건 중 _START_~_END_번째",
          "paginate": {
            "next": "다음",
            "previous": "이전"
          }
        }
    });

    // 텍스트 입력 필터 이벤트 바인딩
    $('#comparisonTable thead tr:eq(1) th').each(function(i) {
        var input = $(this).find('input');
        if(input.length) {
            input.on('keyup change clear', function() {
                if(table.column(i).search() !== this.value) {
                    table.column(i).search(this.value).draw();
                }
            });
        }
    });

    // 드롭다운 필터 이벤트 바인딩 (대소문자 구분 없이 단순 문자열 포함 검색)
    $('#comparisonTable thead tr:eq(1) th').each(function(i) {
        var select = $(this).find('select');
        if(select.length) {
            select.on('change', function() {
                var val = $(this).val();
                table.column(i).search(val || '', false, false).draw();
            });
        }
    });

    // 필터 토글 버튼 클릭 시 필터 입력창 행 보여주기/숨기기
    $('#toggle-filter-btn').click(function() {
        var filterRow = $('#filter-row');
        filterRow.toggle();

        // 필터 영역이 나왔다 사라질 때 컬럼 조정 (옵션)
        table.columns.adjust().draw();
    });
});
</script>

</body>
</html>

