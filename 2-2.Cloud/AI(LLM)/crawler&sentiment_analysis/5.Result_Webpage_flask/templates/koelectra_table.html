<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KoELECTRA Articles Table - sb-admin-2</title>
    <link href="static/css/bootstrap.min.css" rel="stylesheet" />
    <link href="static/css/sb-admin-2.min.css" rel="stylesheet" />
    <link href="static/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
    <link href="static/css/jquery-ui.min.css" rel="stylesheet" />
    <style>
      thead input, thead select {
        width: 100%;
        box-sizing: border-box;
        height: 32px;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      th.date-filter { min-width: 250px; white-space: nowrap; }
      .date-range-group { display: flex; gap: 6px; }
      .date-range-group input {
        width: 120px; min-width: 100px; max-width: 130px; display: inline-block; margin: 0;
      }
      #toggle-filter-btn { padding: 3px 8px; font-size: 0.875rem; }
    </style>
</head>
<body id="page-top">
{% set active_tab = 'koelectra' %}
{% include 'header.html' %}

<div class="container-fluid mt-4">

    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="koelectraTable" width="100%" cellspacing="0">
                    <thead class="thead-dark">
                        <tr>
                            <th>id</th>
                            <th>keyword_id</th>
                            <th>keyword</th>
                            <th>title</th>
                            <th>content</th>
                            <th>url</th>
                            <th>sentiment</th>
                            <th>score</th>
                            <th>published_at</th>
                            <th>collected_at</th>
                        </tr>
                        <!-- 필터 입력행: 기본 숨김, 토글로 보임/숨김 -->
                        <tr id="filter-row" style="display:none;">
                            <th><input type="text" placeholder="검색 id" /></th>
                            <th><input type="text" placeholder="검색 keyword_id" /></th>
                            <th><input type="text" placeholder="검색 keyword" /></th>
                            <th><input type="text" placeholder="검색 title" /></th>
                            <th><input type="text" placeholder="검색 content" /></th>
                            <th><input type="text" placeholder="검색 url" /></th>
                            <th>
                                <select>
                                    <option value="">전체</option>
                                    {% set sentiments = ['angry', 'happy', 'anxious', 'embarrassed', 'sad', 'heartache'] %}
                                    {% for s in sentiments %}
                                    <option value="{{ s }}">{{ s|capitalize }}</option>
                                    {% endfor %}
                                </select>
                            </th>
                            <th><input type="text" placeholder="검색 score" /></th>
                            <th class="date-filter">
                                <div class="date-range-group">
                                    <input type="text" id="published_at_min" placeholder="시작일 (YYYY-MM-DD)" autocomplete="off" />
                                    <input type="text" id="published_at_max" placeholder="종료일 (YYYY-MM-DD)" autocomplete="off" />
                                </div>
                            </th>
                            <th class="date-filter">
                                <div class="date-range-group">
                                    <input type="text" id="collected_at_min" placeholder="시작일 (YYYY-MM-DD)" autocomplete="off" />
                                    <input type="text" id="collected_at_max" placeholder="종료일 (YYYY-MM-DD)" autocomplete="off" />
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in data %}
                        <tr>
                            {% for value in row %}
                                {% set idx = loop.index0 %}
                                {% if idx == 5 %}
                                    <td><a href="{{ value }}" target="_blank" rel="noopener noreferrer">기사링크</a></td>
                                {% elif idx == 6 %}
                                    <td>
                                        {% set emoji_map = {
                                            'angry': '😠',
                                            'happy': '😊',
                                            'anxious': '😰',
                                            'embarrassed': '😳',
                                            'sad': '😢',
                                            'heartache': '💔'
                                        } %}
                                        {{ emoji_map.get(value|lower, '❓') }} {{ value }}
                                    </td>
                                {% elif idx == 7 %}
                                    <td style="min-width: 120px;">
                                        <div>{{ "%.3f"|format(value) }}</div>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar"
                                                 style="width: {{ (value * 100)|round(2) }}%;"
                                                 aria-valuenow="{{ (value * 100)|round(2) }}"
                                                 aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </td>
                                {% else %}
                                    <td>{{ value }}</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/dataTables.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
<script>
$(document).ready(function() {
    var table = $('#koelectraTable').DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        language: {
            search: "검색:",
            lengthMenu: "페이지당 _MENU_ 개씩 보기",
            info: "_TOTAL_건 중 _START_~_END_번째",
            paginate: { next: "다음", previous: "이전" }
        }
    });

    // 필터 토글 버튼 동적 생성 (lengthMenu 오른쪽)
    $('#toggle-filter-btn').remove();
    $('<button id="toggle-filter-btn" class="btn btn-secondary ml-2 btn-sm">필터 토글</button>')
        .insertAfter('.dataTables_length');

    // 토글 이벤트
    $(document).on('click', '#toggle-filter-btn', function() {
        $('#filter-row').toggle();
        table.columns.adjust().draw();
    });

    // 텍스트 필터
    $('#koelectraTable thead tr:eq(1) th').each(function(i) {
        var input = $(this).find('input[type="text"]:not(#published_at_min):not(#published_at_max):not(#collected_at_min):not(#collected_at_max)');
        if(input.length) {
            input.on('keyup change clear', function() {
                if(table.column(i).search() !== this.value) {
                    table.column(i).search(this.value).draw();
                }
            });
        }
    });

    // 드롭다운 필터
    $('#koelectraTable thead tr:eq(1) th').each(function(i) {
        var select = $(this).find('select');
        if(select.length) {
            select.on('change', function() {
                var val = $(this).val();
                table.column(i).search(val || '', false, false).draw();
            });
        }
    });

    // Datepicker
    $("#published_at_min, #published_at_max, #collected_at_min, #collected_at_max").datepicker({
        dateFormat: "yy-mm-dd"
    });

    // 날짜 필터링 (시간 제외, 날짜만 비교)
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        function extractDatePart(datetimeStr) {
            if (!datetimeStr) return null;
            var datePart = datetimeStr.split(' ')[0];
            return datePart;
        }
        function parseDate(s) {
            if (!s) return null;
            var parts = s.split('-');
            if(parts.length !== 3) return null;
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }
        var publishedRaw = data[8], collectedRaw = data[9];
        var published = parseDate(extractDatePart(publishedRaw));
        var collected = parseDate(extractDatePart(collectedRaw));
        var publishedMin = $('#published_at_min').val();
        var publishedMax = $('#published_at_max').val();
        var collectedMin = $('#collected_at_min').val();
        var collectedMax = $('#collected_at_max').val();
        var publishedMinDate = parseDate(publishedMin), publishedMaxDate = parseDate(publishedMax);
        var collectedMinDate = parseDate(collectedMin), collectedMaxDate = parseDate(collectedMax);

        if (published) {
            if (publishedMinDate && published < publishedMinDate) return false;
            if (publishedMaxDate && published > publishedMaxDate) return false;
        }
        if (collected) {
            if (collectedMinDate && collected < collectedMinDate) return false;
            if (collectedMaxDate && collected > collectedMaxDate) return false;
        }
        return true;
    });

    $('#published_at_min, #published_at_max, #collected_at_min, #collected_at_max').on('change', function() {
        table.draw();
    });
});
</script>
</body>
</html>

