<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>KoELECTRA Articles Table - sb-admin-2</title>
    <link href="static/css/bootstrap.min.css" rel="stylesheet" />
    <link href="static/css/sb-admin-2.min.css" rel="stylesheet" />
    <link href="static/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
    <link href="static/css/jquery-ui.min.css" rel="stylesheet" />
    <style>
      thead input, thead select {
        width: 100%;
        box-sizing: border-box;
        height: 32px;
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      th.date-filter { min-width: 250px; white-space: nowrap; }
      .date-range-group { display: flex; gap: 6px; }
      .date-range-group input {
        width: 120px; min-width: 100px; max-width: 130px; display: inline-block; margin: 0;
      }
      #toggle-filter-btn { padding: 3px 8px; font-size: 0.875rem; }
    </style>
</head>
<body id="page-top">
{% set active_tab = 'koelectra' %}
{% include 'header.html' %}

<div class="container-fluid mt-4">

    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="koelectraTable" width="100%" cellspacing="0">
                    <thead class="thead-dark">
                        <tr>
                            <th>id</th>
                            <th>keyword_id</th>
                            <th>keyword</th>
                            <th>title</th>
                            <th>content</th>
                            <th>url</th>
                            <th>sentiment</th>
                            <th>score</th>
                            <th>published_at</th>
                            <th>collected_at</th>
                        </tr>
                        <!-- í•„í„° ì…ë ¥í–‰: ê¸°ë³¸ ìˆ¨ê¹€, í† ê¸€ë¡œ ë³´ì„/ìˆ¨ê¹€ -->
                        <tr id="filter-row" style="display:none;">
                            <th><input type="text" placeholder="ê²€ìƒ‰ id" /></th>
                            <th><input type="text" placeholder="ê²€ìƒ‰ keyword_id" /></th>
                            <th><input type="text" placeholder="ê²€ìƒ‰ keyword" /></th>
                            <th><input type="text" placeholder="ê²€ìƒ‰ title" /></th>
                            <th><input type="text" placeholder="ê²€ìƒ‰ content" /></th>
                            <th><input type="text" placeholder="ê²€ìƒ‰ url" /></th>
                            <th>
                                <select>
                                    <option value="">ì „ì²´</option>
                                    {% set sentiments = ['angry', 'happy', 'anxious', 'embarrassed', 'sad', 'heartache'] %}
                                    {% for s in sentiments %}
                                    <option value="{{ s }}">{{ s|capitalize }}</option>
                                    {% endfor %}
                                </select>
                            </th>
                            <th><input type="text" placeholder="ê²€ìƒ‰ score" /></th>
                            <th class="date-filter">
                                <div class="date-range-group">
                                    <input type="text" id="published_at_min" placeholder="ì‹œì‘ì¼ (YYYY-MM-DD)" autocomplete="off" />
                                    <input type="text" id="published_at_max" placeholder="ì¢…ë£Œì¼ (YYYY-MM-DD)" autocomplete="off" />
                                </div>
                            </th>
                            <th class="date-filter">
                                <div class="date-range-group">
                                    <input type="text" id="collected_at_min" placeholder="ì‹œì‘ì¼ (YYYY-MM-DD)" autocomplete="off" />
                                    <input type="text" id="collected_at_max" placeholder="ì¢…ë£Œì¼ (YYYY-MM-DD)" autocomplete="off" />
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in data %}
                        <tr>
                            {% for value in row %}
                                {% set idx = loop.index0 %}
                                {% if idx == 5 %}
                                    <td><a href="{{ value }}" target="_blank" rel="noopener noreferrer">ê¸°ì‚¬ë§í¬</a></td>
                                {% elif idx == 6 %}
                                    <td>
                                        {% set emoji_map = {
                                            'angry': 'ğŸ˜ ',
                                            'happy': 'ğŸ˜Š',
                                            'anxious': 'ğŸ˜°',
                                            'embarrassed': 'ğŸ˜³',
                                            'sad': 'ğŸ˜¢',
                                            'heartache': 'ğŸ’”'
                                        } %}
                                        {{ emoji_map.get(value|lower, 'â“') }} {{ value }}
                                    </td>
                                {% elif idx == 7 %}
                                    <td style="min-width: 120px;">
                                        <div>{{ "%.3f"|format(value) }}</div>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar"
                                                 style="width: {{ (value * 100)|round(2) }}%;"
                                                 aria-valuenow="{{ (value * 100)|round(2) }}"
                                                 aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </td>
                                {% else %}
                                    <td>{{ value }}</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/dataTables.bootstrap4.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
<script>
$(document).ready(function() {
    var table = $('#koelectraTable').DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        language: {
            search: "ê²€ìƒ‰:",
            lengthMenu: "í˜ì´ì§€ë‹¹ _MENU_ ê°œì”© ë³´ê¸°",
            info: "_TOTAL_ê±´ ì¤‘ _START_~_END_ë²ˆì§¸",
            paginate: { next: "ë‹¤ìŒ", previous: "ì´ì „" }
        }
    });

    // í•„í„° í† ê¸€ ë²„íŠ¼ ë™ì  ìƒì„± (lengthMenu ì˜¤ë¥¸ìª½)
    $('#toggle-filter-btn').remove();
    $('<button id="toggle-filter-btn" class="btn btn-secondary ml-2 btn-sm">í•„í„° í† ê¸€</button>')
        .insertAfter('.dataTables_length');

    // í† ê¸€ ì´ë²¤íŠ¸
    $(document).on('click', '#toggle-filter-btn', function() {
        $('#filter-row').toggle();
        table.columns.adjust().draw();
    });

    // í…ìŠ¤íŠ¸ í•„í„°
    $('#koelectraTable thead tr:eq(1) th').each(function(i) {
        var input = $(this).find('input[type="text"]:not(#published_at_min):not(#published_at_max):not(#collected_at_min):not(#collected_at_max)');
        if(input.length) {
            input.on('keyup change clear', function() {
                if(table.column(i).search() !== this.value) {
                    table.column(i).search(this.value).draw();
                }
            });
        }
    });

    // ë“œë¡­ë‹¤ìš´ í•„í„°
    $('#koelectraTable thead tr:eq(1) th').each(function(i) {
        var select = $(this).find('select');
        if(select.length) {
            select.on('change', function() {
                var val = $(this).val();
                table.column(i).search(val || '', false, false).draw();
            });
        }
    });

    // Datepicker
    $("#published_at_min, #published_at_max, #collected_at_min, #collected_at_max").datepicker({
        dateFormat: "yy-mm-dd"
    });

    // ë‚ ì§œ í•„í„°ë§ (ì‹œê°„ ì œì™¸, ë‚ ì§œë§Œ ë¹„êµ)
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        function extractDatePart(datetimeStr) {
            if (!datetimeStr) return null;
            var datePart = datetimeStr.split(' ')[0];
            return datePart;
        }
        function parseDate(s) {
            if (!s) return null;
            var parts = s.split('-');
            if(parts.length !== 3) return null;
            return new Date(parts[0], parts[1] - 1, parts[2]);
        }
        var publishedRaw = data[8], collectedRaw = data[9];
        var published = parseDate(extractDatePart(publishedRaw));
        var collected = parseDate(extractDatePart(collectedRaw));
        var publishedMin = $('#published_at_min').val();
        var publishedMax = $('#published_at_max').val();
        var collectedMin = $('#collected_at_min').val();
        var collectedMax = $('#collected_at_max').val();
        var publishedMinDate = parseDate(publishedMin), publishedMaxDate = parseDate(publishedMax);
        var collectedMinDate = parseDate(collectedMin), collectedMaxDate = parseDate(collectedMax);

        if (published) {
            if (publishedMinDate && published < publishedMinDate) return false;
            if (publishedMaxDate && published > publishedMaxDate) return false;
        }
        if (collected) {
            if (collectedMinDate && collected < collectedMinDate) return false;
            if (collectedMaxDate && collected > collectedMaxDate) return false;
        }
        return true;
    });

    $('#published_at_min, #published_at_max, #collected_at_min, #collected_at_max').on('change', function() {
        table.draw();
    });
});
</script>
</body>
</html>

